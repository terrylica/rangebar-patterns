# ClickHouse local server management + remote sync

["ch:status"]
description = "Check local ClickHouse status and data counts"
run = """
#!/usr/bin/env bash
set -euo pipefail

if clickhouse client --query "SELECT version()" 2>/dev/null; then
    echo "ClickHouse: Running"
    echo ""
    echo "=== Range Bars ==="
    clickhouse client --query "
        SELECT symbol, threshold_decimal_bps as dbps, count() as rows
        FROM rangebar_cache.range_bars
        GROUP BY symbol, threshold_decimal_bps
        ORDER BY rows DESC
        FORMAT PrettyCompact
    " 2>/dev/null || echo "(no range_bars table)"
    echo ""
    echo "=== Feature Combinations ==="
    clickhouse client --query "SELECT count() as rows FROM rangebar_cache.feature_combinations" 2>/dev/null || echo "(no table)"
else
    echo "ClickHouse: NOT running"
    echo "Start with: mise run ch:start"
fi
"""

["ch:sync"]
description = "Sync @250dbps data from remote ClickHouse via SSH tunnel + remote() function"
run = """
#!/usr/bin/env bash
set -euo pipefail

CH_HOST="${RANGEBAR_CH_HOST:-localhost}"
echo "Opening SSH tunnel to ${CH_HOST} (port 19000 -> 9000)..."
ssh -N -L 19000:localhost:9000 "$CH_HOST" &
TUNNEL_PID=$!
trap "kill $TUNNEL_PID 2>/dev/null" EXIT
sleep 2

# Verify tunnel
echo "Verifying tunnel..."
REMOTE_COUNT=$(clickhouse client --query "SELECT count() FROM remote('localhost:19000', 'rangebar_cache', 'range_bars', 'default', '') WHERE threshold_decimal_bps = 250")
echo "${CH_HOST} has $REMOTE_COUNT rows at @250dbps"

LOCAL_COUNT=$(clickhouse client --query "SELECT count() FROM rangebar_cache.range_bars WHERE threshold_decimal_bps = 250" 2>/dev/null || echo "0")
echo "Local has $LOCAL_COUNT rows at @250dbps"

if [ "$LOCAL_COUNT" = "$REMOTE_COUNT" ]; then
    echo "Already in sync!"
    exit 0
fi

echo ""
echo "Syncing range_bars (@250dbps)..."
clickhouse client --query "
INSERT INTO rangebar_cache.range_bars
SELECT * FROM remote('localhost:19000', 'rangebar_cache', 'range_bars', 'default', '')
WHERE threshold_decimal_bps = 250
"

echo "Syncing feature_combinations..."
clickhouse client --query "TRUNCATE TABLE IF EXISTS rangebar_cache.feature_combinations"
clickhouse client --query "
INSERT INTO rangebar_cache.feature_combinations
SELECT * FROM remote('localhost:19000', 'rangebar_cache', 'feature_combinations', 'default', '')
"

echo ""
echo "=== Sync Complete ==="
clickhouse client --query "
    SELECT symbol, count() as rows
    FROM rangebar_cache.range_bars
    WHERE threshold_decimal_bps = 250
    GROUP BY symbol
    ORDER BY rows DESC
    FORMAT PrettyCompact
"
"""
